<!DOCTYPE html>
<html>
<head>
    <title>图片与键盘输入检测</title>
    <style>
        #preview { max-width: 300px; max-height: 300px; border: 1px solid #ccc; }
        #status { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        #result { margin: 10px 0; padding: 10px; background: #e8f5e8; border: 1px solid #4caf50; }
    </style>
</head>
<body>
    <h1>图片上传与键盘输入检测</h1>
    
    <div>
        <input type="file" id="imageInput" accept="image/*">
        <img id="preview" src="" alt="图片预览">
    </div>
    
    <div>
        <p>按 WASD 键进行输入：</p>
        <div id="keyDisplay">当前按键：无</div>
    </div>
    
    <div id="status">准备就绪</div>
    <div id="result"></div>

    <script>
        let currentImage = null;
        let currentKeys = [];

        // 图片上传处理
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview').src = e.target.result;
                    currentImage = e.target.result;
                    setStatus('图片上传成功！现在可以按WASD键测试');
                };
                reader.readAsDataURL(file);
            }
        });

        // 键盘输入检测
        document.addEventListener('keydown', function(e) {
            const key = e.key.toLowerCase();
            if (['w', 'a', 's', 'd'].includes(key) && !currentKeys.includes(key)) {
                currentKeys.push(key);
                updateKeyDisplay();
                sendToServer();
            }
        });

        document.addEventListener('keyup', function(e) {
            const key = e.key.toLowerCase();
            const index = currentKeys.indexOf(key);
            if (index > -1) {
                currentKeys.splice(index, 1);
                updateKeyDisplay();
            }
        });

        function updateKeyDisplay() {
            document.getElementById('keyDisplay').textContent = 
                `当前按键：${currentKeys.join(', ') || '无'}`;
        }

        // 发送到服务器 - 修复后的版本
        async function sendToServer() {
            if (!currentImage) {
                setStatus('请先上传图片');
                return;
            }

            setStatus('发送数据到服务器...');
            
            try {
                const response = await fetch('http://101.126.31.72:5000/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: currentImage,
                        keys: currentKeys
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }

                const result = await response.json();
                console.log('服务器返回:', result); // 调试用
                
                // 安全地处理返回数据
                let resultHTML = `<strong>服务器返回结果：</strong><br>`;
                
                if (result.success) {
                    resultHTML += `情感: ${result.result}<br>`;
                    resultHTML += `图片尺寸: ${result.image_size || '未知'}<br>`;
                    resultHTML += `接收到的按键: ${result.keys_received ? result.keys_received.join(', ') : '无'}<br>`;
                    resultHTML += `处理时间: ${result.processed_at || '未知'}`;
                } else {
                    resultHTML += `错误: ${result.error}`;
                }
                
                document.getElementById('result').innerHTML = resultHTML;
                setStatus('处理完成！');
                
            } catch (error) {
                setStatus('发送失败：' + error.message);
                console.error('错误详情:', error);
            }
        }

        function setStatus(message) {
            document.getElementById('status').textContent = message;
        }
    </script>
</body>
</html>